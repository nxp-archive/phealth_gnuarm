2009-07-22  Richard Henderson  <rth@redhat.com>

	* eh_cpp.c: New file.
	* Makefile.am (libitm_la_SOURCES): Add it.
	* Makefile.in: Rebuild.
	* beginend.c (GTM_rollback_transaction): Undo exception state.
	(GTM_trycommit_transaction): Mark inline.
	(GTM_trycommit_and_finalize_transaction): Split out from ...
	(_ITM_commitTransaction): ... here.
	(_ITM_commitTransactionEH): New function.
	* libitm.h (struct gtm_transaction): Add cxa_catch_count,
	cxa_unthrown, eh_in_flight; reorder.

	* testsuite/libitm.c++/c++.exp: New.
	* testsuite/libitm.c++/eh-1.C: New.

	* aatree.c (aa_free): Remove REGPARM.
	* aatree.h: Remove all REGPARM.

2009-07-18  Richard Henderson  <rth@redhat.com>

        * aatree.c, aatree.h, alloc.c, alloc_c.c, alloc_cpp.c: New files.
        * Makefile.am (libitm_la_SOURCES): Add them.
        * Makefile.in: Rebuild.
        * beginend.c (GTM_rollback_transaction): Use GTM_commit_allocations.
        (GTM_trycommit_transaction): Likewise.
        * libitm.h: Include aatree.h
        (struct gtm_alloc_action): New.
        (struct gtm_transaction): Add alloc_actions.
        (GTM_record_allocation, GTM_forget_allocation): Declare.
        (GTM_get_allocation_size, GTM_commit_allocations): Declare.
        * libitm.map (_ITM_malloc, _ITM_calloc, _ITM_realloc, _ITM_free,
        _ZGTtnwm, _ZGTtnam, _ZGTtdlPv, _ZGTtdaPv, _ZGTtnwmRKSt9nothrow_t,
        _ZGTtnamRKSt9nothrow_t, _ZGTtdlPvRKSt9nothrow_t,
        _ZGTtdaPvRKSt9nothrow_t): Export.

2009-07-18  Richard Henderson  <rth@redhat.com>

	* target_tls.h: Move ...
	* config/posix/target_tls.h: ... here.

2009-07-07  Richard Henderson  <rth@redhat.com>

	* config/x86/target.h (atomic_write_barrier): Use sfence if available.

2009-07-07  Richard Henderson  <rth@redhat.com>

	* Update to GPL3.

2009-07-07  Richard Henderson  <rth@redhat.com>

	* libitm.h (struct gtm_transaction): Widen id to _ITM_transactionId_t.
	* beginend.c (global_tid): Widen to _ITM_transactionId_t.

	* configure.tgt: Don't use -ftls-model for x86 linux.
	* libitm.h: Include target.h after standard includes.
	(_gtm_thr): Rename from gtm_thr.
	(setup_gtm_thr, gtm_thr, gtm_tx, set_gtm_tx): New.
	(gtm_disp, set_gtm_disp): New.
	* beginend.c, dispatch.c, local.c, method-wbetl.c, query.c,
	retry.c, serial.c, useraction.c: Use accessor functions throughout.
	* config/alpha/target_tls.h, config/x86/target_tls.h: New files.

2009-07-07  Richard Henderson  <rth@redhat.com>

	* config/linux/rwlock.c (EZ): New define.  Use it throughout.

2009-07-06  Richard Henderson  <rth@redhat.com>

	* libitm.h (_ITM_SRCLOCATION_DECL_1, _ITM_SRCLOCATION_DECL_2): Remove.
	(_ITM_SRCLOCATION_DEFN_1, _ITM_SRCLOCATION_DEFN_2): Remove.
	(_ITM_beginTransaction): Take variadic arguments.
	(_ITM_registerThrownObject): Declare.
	* beginend.c, serial.c: Update.
	* libitm.map: Add _ITM_registerThrownObject.

2009-01-28  Richard Henderson  <rth@redhat.com>

	* Makefile.am (libitm_la_SOURCES): Add clone.c.
	* Makefile.in: Rebuild.
	* beginend.c (_ITM_abortTransaction): Abort if irrevokable.
	(GTM_restart_transaction): Fix uninstrumented code check.
	* retry.c (GTM_decide_retry_strategy): Add serial check.
	* serial.c (GTM_serialmode): Add irrevokable variable.  Don't
	automatically go irrevokable when in serial mode.
	* clone.c: New file.
	* libitm.h, libitm.map: Update.

2009-01-27  Richard Henderson  <rth@redhat.com>

	* Makefile.am (LTCCASCOMPILE): Define.
	(libitm_la_SOURCES): Add methid-wbetl.c.
	* testsuite/Makefile.am: New
	* configure.ac: Add testsuite/Makefile.
	* Makefile.in, testsuite/Makefile.in, configure: Regenerate.
	* beginend.c (GTM_begin_transaction): Install wbetl_dispatch.
	(_ITM_abortTransaction): Finalize implementation method; pass
	transaction properties to longjmp.
	(GTM_restart_transaction): Split out from ...
	(_ITM_commitTransaction): ... here.
	* config/linux/x86/futex_bits.h (cpu_relax, atomic_write_barrier):
	Move to config/x86/target.h.
	* config/linux/alpha/futex_bits.h: New.
	* config/x86/sjlj.S (GTM_longjmp): Fix 64-bit input register.
	* config/x86/target.h: Disable target types for 32-bit.
	* config/alpha/sjlj.S, config/alpha/target.h: New.
	* libitm.h (struct gtm_dispatch): Add init, fini.
	(enum restart_reason): New.
	(struct gtm_transaction): Add method and restarts.
	* retry.c (GTM_decide_retry_strategy): Implement.
	* serial.c (serial_init, serial_fini): New.
	(GTM_serialmode): Finialize outgoing method.
	* method-wbetl.c: New.

2008-12-09  Richard Henderson  <rth@redhat.com>

	* config/x86/target.h (_ITM_ALL_TARGET_TYPES, _ITM_TYPE_ATTR): New.
	* configure.tgt (i386-*, x86_64-*): Don't force SSE.
	* dispatch.c (_ITM_##R##T, _ITM_##W##T): Use _ITM_TYPE_ATTR.
	* libitm.h (_ITM_ALL_TARGET_TYPES, _ITM_TYPE_ATTR): Provide default.
	(_ITM_TYPE_M64, _ITM_TYPE_M128, _ITM_TYPE_M256): Move to x86 header.
	(_ITM_ALL_TYPES): Use _ITM_ALL_TARGET_TYPES.
	* local.c (_ITM_L##T): Use _ITM_TYPE_ATTR.
	* serial.c (serial_R##T, serial_W##T): Likewise.

2008-11-21  Richard Henderson  <rth@redhat.com>

	* Initial commit.
