2009-11-03  Richard Henderson  <rth@redhat.com>

	* method-readonly.c: New file.
	* Makefile.am (libitm_la_SOURCES): Add it.
	* Makefile.in: Rebuild.
	* beginend.c (gtm_stmlock_array, gtm_clock): New.
	(GTM_begin_transaction): Use dispatch_readonly for read-only txn.
	* libitm_i.h (gtm_stmlock, gtm_version): Move from method-wbetl.c.
	(GTM_VERSION_MAX, GTM_VERSION_INVALID, gtm_stmlock_owned_p,
	gtm_stmlock_set_owned, gtm_stmlock_get_addr,
	gtm_stmlock_get_version, gtm_stmlock_set_version, LOCK_ARRAY_SIZE,
	gtm_stmlock_array, gtm_get_stmlock, gtm_clock, RESTART_NOT_READONLY,
	gtm_get_clock, gtm_inc_clock): New.
	* method-wbetl.c (gtm_version, gtm_stmlock, OWNED_MASK, VERSION_MAX,
	LOCK_GET_OWNED, LOCK_SET_ADDR, LOCK_GET_ADDR, LOCK_GET_TIMESTAMP,
	LOCK_SET_TIMESTAMP, LOCK_ARRAY_SIZE, LOCK_MASK, LOCK_IDX, GET_LOCK,
	locks, gclock, CLOCK, GET_CLOCK, FETCH_AND_INC_CLOCK): Remove and
	replace uses with new libitm_i.h symbols.
	(dispatch_wbetl): Rename from wbetl_dispatch.
	* retry.c (GTM_decide_retry_strategy): If RESTART_NOT_READONLY, move
	away from dispatch_readonly; abort if the beginTransaction call
	asserted that the transaction was readonly.

2009-11-03  Richard Henderson  <rth@redhat.com>

	* memset.c: New file.
	* Makefile.am (libitm_la_SOURCES): Add it.
	* Makefile.in: Rebuild.
	* testsuite/libitm.c/memset-1.c: New.

2009-11-03  Richard Henderson  <rth@redhat.com>

	* dispatch.c: Remove file.
	* useraction.c (struct gtm_user_action): Move from libitm.h.
	* serial.c (GTM_null_read_lock, GTM_null_write_lock): New.
	(serial_memset, serial_memmove, serial_memcpy): Remove.
	(serial_W*, serial_R*): Remove.
	(serial_dispatch): Update to match.
	* configure.ac: Move Werror down below configure checks.  Don't
	check for sys/loadavg.h, do check for malloc.h.  Don't check for
	getloadavg and clock_gettime; do check for memalign, posix_memalign.
	Use GCC_AC_FUNC_MMAP_BLACKLIST
	* libitm.h: Split out all internal items to...
	* libitm_i.h: ... here.  New file.
	* copymask.c: New file.
	* local.c (struct gtm_local_undo): Move from libitm.h.
	(GTM_alloc_local): Rename from alloc_local; export.
	* memcpy.c: New file.
	* alloc_c.c (_ITM_realloc): Use _ITM_memcpyRnWt directly.
	* config/posix/page.c: New file.
	* config/posix/target_tls.h: Remove file.
	* barrier.c: New file.
	* Makefile.am (libitm_la_SOURCES): Add barrier.c, memcpy.c,
	copymask.c, page.c.
	* alloc.c (struct gtm_alloc_action): Move from libitm.h.
	* method-wbetl.c: Rewrite for new cacheline methods.
	* Makefile.in, configure, testsuite/Makefile.in, config.h.in: Rebuild.

	* config/alpha/sjlj.S: Fix typo.
	* config/alpha/target_i.h: Copy functions from alpha/target.h.
	* config/alpha/copymask.c: New file.
	* config/alpha/target.h (CACHELINE_SIZE): New.
	(STRICT_ALIGNMENT, PAGE_SIZE, FIXED_PAGE_SIZE): New.

	* config/x86/target_i.h: Copy functions from x86/target.h.
	* config/x86/copymask.c: New file.
	* config/x86/target.h (_ITM_ALL_TARGET_TYPES): Remove.
	(CACHELINE_SIZE, STRICT_ALIGNMENT): New.
	(PAGE_SIZE, FIXED_PAGE_SIZE): New.
	* config/x86/target_tls.h: Move contents to target_i.h.

	* testsuite/libitm.c/clone-1.c: Include libitm.h.
	* testsuite/libitm.c/memcpy-1.c: New.

2009-10-22  Richard Henderson  <rth@redhat.com>

	* Makefile.am (CCAS, CCASFLAGS, LTCCASCOMPILE): Remove.
	(AM_CCASFLAGS): New.
	* configure.ac: Add AM_PROG_AS.  Use m4_rename_force for
	saving/restoring _AC_ARG_VAR_PRECIOUS.
	* Makefile.in, aclocal.m4, config.h.in, configure,
	testsuite/Makefile.in: Rebuild with automake 1.11; autoconf 2.64.

2009-10-22  Richard Henderson  <rth@redhat.com>

	* testsuite/*: Update for new compiler syntax.

2009-10-21  Richard Henderson  <rth@redhat.com>

	* libitm.h (_ITM_abortReason): Add outerAbort.

2009-08-03  Richard Henderson  <rth@redhat.com>

	* libitm.map (_ITM_commitTransactionEH, _ITM_cxa_allocate_exception,
	_ITM_cxa_begin_catch, _ITM_cxa_end_catch, _ITM_cxa_throw): Export.
	* method-wbetl.c (struct w_entry): Remove mask.
	(wbetl_write, wbetl_load): Return pointer to word containing the data;
	adjust all callers.

2009-07-22  Richard Henderson  <rth@redhat.com>

	* eh_cpp.c: New file.
	* Makefile.am (libitm_la_SOURCES): Add it.
	* Makefile.in: Rebuild.
	* beginend.c (GTM_rollback_transaction): Undo exception state.
	(GTM_trycommit_transaction): Mark inline.
	(GTM_trycommit_and_finalize_transaction): Split out from ...
	(_ITM_commitTransaction): ... here.
	(_ITM_commitTransactionEH): New function.
	* libitm.h (struct gtm_transaction): Add cxa_catch_count,
	cxa_unthrown, eh_in_flight; reorder.

	* testsuite/libitm.c++/c++.exp: New.
	* testsuite/libitm.c++/eh-1.C: New.

	* aatree.c (aa_free): Remove REGPARM.
	* aatree.h: Remove all REGPARM.

2009-07-18  Richard Henderson  <rth@redhat.com>

        * aatree.c, aatree.h, alloc.c, alloc_c.c, alloc_cpp.c: New files.
        * Makefile.am (libitm_la_SOURCES): Add them.
        * Makefile.in: Rebuild.
        * beginend.c (GTM_rollback_transaction): Use GTM_commit_allocations.
        (GTM_trycommit_transaction): Likewise.
        * libitm.h: Include aatree.h
        (struct gtm_alloc_action): New.
        (struct gtm_transaction): Add alloc_actions.
        (GTM_record_allocation, GTM_forget_allocation): Declare.
        (GTM_get_allocation_size, GTM_commit_allocations): Declare.
        * libitm.map (_ITM_malloc, _ITM_calloc, _ITM_realloc, _ITM_free,
        _ZGTtnwm, _ZGTtnam, _ZGTtdlPv, _ZGTtdaPv, _ZGTtnwmRKSt9nothrow_t,
        _ZGTtnamRKSt9nothrow_t, _ZGTtdlPvRKSt9nothrow_t,
        _ZGTtdaPvRKSt9nothrow_t): Export.

2009-07-18  Richard Henderson  <rth@redhat.com>

	* target_tls.h: Move ...
	* config/posix/target_tls.h: ... here.

2009-07-07  Richard Henderson  <rth@redhat.com>

	* config/x86/target.h (atomic_write_barrier): Use sfence if available.

2009-07-07  Richard Henderson  <rth@redhat.com>

	* Update to GPL3.

2009-07-07  Richard Henderson  <rth@redhat.com>

	* libitm.h (struct gtm_transaction): Widen id to _ITM_transactionId_t.
	* beginend.c (global_tid): Widen to _ITM_transactionId_t.

	* configure.tgt: Don't use -ftls-model for x86 linux.
	* libitm.h: Include target.h after standard includes.
	(_gtm_thr): Rename from gtm_thr.
	(setup_gtm_thr, gtm_thr, gtm_tx, set_gtm_tx): New.
	(gtm_disp, set_gtm_disp): New.
	* beginend.c, dispatch.c, local.c, method-wbetl.c, query.c,
	retry.c, serial.c, useraction.c: Use accessor functions throughout.
	* config/alpha/target_tls.h, config/x86/target_tls.h: New files.

2009-07-07  Richard Henderson  <rth@redhat.com>

	* config/linux/rwlock.c (EZ): New define.  Use it throughout.

2009-07-06  Richard Henderson  <rth@redhat.com>

	* libitm.h (_ITM_SRCLOCATION_DECL_1, _ITM_SRCLOCATION_DECL_2): Remove.
	(_ITM_SRCLOCATION_DEFN_1, _ITM_SRCLOCATION_DEFN_2): Remove.
	(_ITM_beginTransaction): Take variadic arguments.
	(_ITM_registerThrownObject): Declare.
	* beginend.c, serial.c: Update.
	* libitm.map: Add _ITM_registerThrownObject.

2009-01-28  Richard Henderson  <rth@redhat.com>

	* Makefile.am (libitm_la_SOURCES): Add clone.c.
	* Makefile.in: Rebuild.
	* beginend.c (_ITM_abortTransaction): Abort if irrevokable.
	(GTM_restart_transaction): Fix uninstrumented code check.
	* retry.c (GTM_decide_retry_strategy): Add serial check.
	* serial.c (GTM_serialmode): Add irrevokable variable.  Don't
	automatically go irrevokable when in serial mode.
	* clone.c: New file.
	* libitm.h, libitm.map: Update.

2009-01-27  Richard Henderson  <rth@redhat.com>

	* Makefile.am (LTCCASCOMPILE): Define.
	(libitm_la_SOURCES): Add methid-wbetl.c.
	* testsuite/Makefile.am: New
	* configure.ac: Add testsuite/Makefile.
	* Makefile.in, testsuite/Makefile.in, configure: Regenerate.
	* beginend.c (GTM_begin_transaction): Install wbetl_dispatch.
	(_ITM_abortTransaction): Finalize implementation method; pass
	transaction properties to longjmp.
	(GTM_restart_transaction): Split out from ...
	(_ITM_commitTransaction): ... here.
	* config/linux/x86/futex_bits.h (cpu_relax, atomic_write_barrier):
	Move to config/x86/target.h.
	* config/linux/alpha/futex_bits.h: New.
	* config/x86/sjlj.S (GTM_longjmp): Fix 64-bit input register.
	* config/x86/target.h: Disable target types for 32-bit.
	* config/alpha/sjlj.S, config/alpha/target.h: New.
	* libitm.h (struct gtm_dispatch): Add init, fini.
	(enum restart_reason): New.
	(struct gtm_transaction): Add method and restarts.
	* retry.c (GTM_decide_retry_strategy): Implement.
	* serial.c (serial_init, serial_fini): New.
	(GTM_serialmode): Finialize outgoing method.
	* method-wbetl.c: New.

2008-12-09  Richard Henderson  <rth@redhat.com>

	* config/x86/target.h (_ITM_ALL_TARGET_TYPES, _ITM_TYPE_ATTR): New.
	* configure.tgt (i386-*, x86_64-*): Don't force SSE.
	* dispatch.c (_ITM_##R##T, _ITM_##W##T): Use _ITM_TYPE_ATTR.
	* libitm.h (_ITM_ALL_TARGET_TYPES, _ITM_TYPE_ATTR): Provide default.
	(_ITM_TYPE_M64, _ITM_TYPE_M128, _ITM_TYPE_M256): Move to x86 header.
	(_ITM_ALL_TYPES): Use _ITM_ALL_TARGET_TYPES.
	* local.c (_ITM_L##T): Use _ITM_TYPE_ATTR.
	* serial.c (serial_R##T, serial_W##T): Likewise.

2008-11-21  Richard Henderson  <rth@redhat.com>

	* Initial commit.
